<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>old page</title>

    <link rel="icon" href="./favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/new_funding.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
        integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"
        integrity="sha512-H6cPm97FAsgIKmlBA4s774vqoN24V5gSQL4yBTDOY2su2DeXZVhQPxFK4P6GPdnZqM9fg1G3cMv5wD7e6cFLZQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/ScrollToPlugin.min.js"
        integrity="sha512-agNfXmEo6F+qcj3WGryaRvl9X9wLMQORbTt5ACS9YVqzKDMzhRxY+xjgO45HCLm61OwHWR1Oblp4QSw/SGh9SA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://unpkg.com/swiper@6.8.4/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper@6.8.4/swiper-bundle.min.js"></script>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.8/ScrollMagic.min.js"
        integrity="sha512-8E3KZoPoZCD+1dgfqhPbejQBnQfBXe8FuwL4z/c8sTrgeDMFEnoyTlH3obB4/fV+6Sg0a0XF+L/6xS4Xx1fUEg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <script defer src="/js/common.js"></script>
</head>

<body>

    <!-- HEADER -->
    <header>
        <div class="inner">

            <a href="/" class="logo">
                <img src="/img/logo.png" alt="STARBUCKS" width="50%">
            </a>

            <div class="sub-menu">
                <ul class="menu">
                    <li>
                        <a href="/Login.html" id="userName">로그인을 해주세요!</a>
                    </li>
                    <li>
                        <a href="/Login.html" id="signin">Sign In</a>
                    </li>
                    <li>
                        <a href="index.html" id="logout">Logout</a>
                    </li>
                </ul>
                <div class="search">
                    <input type="text">
                    <div class="material-icons">search</div>
                </div>
            </div>

            <ul class="main-menu">
                <li class="item">
                    <a href="/index.html">
                        <div class="item__name glitch">홈</div>
                    </a>
                </li>
                <li class="item">
                    <a href="/project_list.html">
                        <div class="item__name glitch">프로젝트 목록</div>
                    </a>
                </li>
                <li class="item">
                    <div class="item__name glitch">프로젝트 신청하기</div>
                </li>
                <li class="item">
                    <a href="/admin.html">
                        <div class="item__name glitch">프로젝트 관리하기</div>
                    </a>
                </li>
    </header>




    <!-- CONTENT -->
    <div class="content">
        <div class="inner">
            <div class="content__title">
                <h1>기존 후원 추가 후원하기</h1>
            </div>
            <div class="content__form">
                <div class="form__title">
                    <h2>후원 정보</h2>
                </div>
                <div class="form__input">
                    <div class="input__title">
                        <h3><span>후원 제목 : <span id = 'sup_name'></span> </span></h3>
                        <h3><span>후원자 명 : <span id = 'sup_user'></span> </span></h3>
                        <h3><span>게시 날짜 : <span id = 'sup_date'></span> </span></h3>
                        <h3><span>모인 금액 : <span id = 'sup_money'></span> </span></h3>
                        <h3><span>후원자 수 : <span id = 'sup_users'></span> </span></h3>
                    </div>
                    
                </div>
                <div class="form__input">
                    <div class="input__title">
                        <h3>프로젝트 금액</h3>
                    </div>
                    <div class="input__box">
                        <textarea name="description" id="new_sup_money" placeholder="후원 금액을 입력해주세요."></textarea>
                    </div>
                </div>
                
                <div class="form__submit">
                    <button id="projectRegister"> 신청하기 </button>
                </div>
            </div>
        </div>
    </div>



    <!--FOOTER -->
    <footer>
        <div class="inner">

            <ul class="menu">
                <li><a href="javascript:void(0)" class="green">개인정보처리방침</a></li>
                <li><a href="javascript:void(0)">영상정보처리기기 운영관리 방침</a></li>
                <li><a href="javascript:void(0)">홈페이지 이용약관</a></li>
                <li><a href="javascript:void(0)">위치정보 이용약관</a></li>
                <li><a href="javascript:void(0)">윤리경영 핫라인</a></li>
            </ul>

            <div class="btn-group">
                <a href="javascript:void(0)" class="btn btn--white">찾아오시는 길</a>
                <a href="javascript:void(0)" class="btn btn--white">신규프로젝트제의</a>
                <a href="javascript:void(0)" class="btn btn--white">사이트 맵</a>
            </div>

            <div class="info">
                <span>사업자등록번호 xxx-xx-xxxxx</span>
                <span>(주)xxxx xxx xxxx xxx</span>
                <span>TEL : 02) xxxx-xxxx / FAX : 02) xxxx-xxxx</span>
                <span>개인정보 책임자 : xxx</span>
            </div>

            <p class="copyright">
                &copy; <span class="this-year"></span> 5조 하늘다람쥐. All Rights Reserved.
            </p>
            <!-- <img src="./images/starbucks_logo_only_text.png" alt="" class="logo"> -->

        </div>
    </footer>


    <div id="to-top">
        <div class="material-icons">arrow_upward</div>
    </div>







    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>



    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <script>

        var firebaseConfig = {
            apiKey: "AIzaSyAjFDujRZbQxm5YY-ynFC5kiLNGzt6NcMI",
                    authDomain: "cccc-2a18a.firebaseapp.com",
                    projectId: "cccc-2a18a",
                    storageBucket: "cccc-2a18a.appspot.com",
                    messagingSenderId: "231950575405",
                    appId: "1:231950575405:web:0320c24b35fbc2749215a4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig) 
    </script>

    <script>
        const db = firebase.firestore();
        const storage = firebase.storage();


            if (localStorage.getItem('user')) {
                    var 뺀거 = localStorage.getItem('user');
                    $('#userName').html(JSON.parse(뺀거).displayName + '님 환영합니다!');
                    //로그인 상태에서 버튼 숨기기
                    if (뺀거) {//로그인 한 상태
                        $('#signin').hide();
                        $('#logout').show();
                    } else {
                        $('#signin').show();
                        $('#logout').hide();
                    }
                }


     

        //로그아웃
        $('#logout').click(function () {
            firebase.auth().signOut().then(function () {
                // Sign-out successful.
                alert('로그아웃 되었습니다.');
                localStorage.removeItem('user');
                location.href = 'index.html';
            }).catch(function (error) {
                // An error happened.
                alert('로그아웃 실패');
            });
        });

        var url = new URL(window.location.href);
        var id = url.searchParams.get("id");
        console.log(id);
        var sup_id = url.searchParams.get("sup_id");
        console.log(sup_id);

        //id와 sup_id로 game collection의 하위 collection인 support collection 정보 가져오기
        db.collection('game').doc(id).collection('support').doc(sup_id).get().then(function (doc) {
            var data = doc.data();
            console.log(data);
            let datetime = data.sup_date.toDate();
            //date형식을 연도, 월, 일로 출력
            let date = datetime.getFullYear() + '-' + (datetime.getMonth() + 1) + '-' + datetime.getDate();

            $('#sup_money').html(data.sup_money);
            $('#sup_date').html(date);
            $('#sup_name').html(data.sup_name);
            $('#sup_users').html(data.sup_user.length);
            $('#sup_user').html(data.sup_user[0]);
        });


        $('#projectRegister').click(function () {
            
             //support collection의 sup_money에 new_sup_money를 더해준다.
             db.collection('game').doc(id).collection('support').doc(sup_id).get().then(function (doc) {
                var data = doc.data();
                console.log(data);
                var new_sup_money = data.sup_money + parseInt($('#new_sup_money').val());
                console.log(new_sup_money);
                db.collection('game').doc(id).collection('support').doc(sup_id).update({
                    sup_money: new_sup_money,
                });
                // game collection의 sup_money에 new_sup_money를 더해준다.
                db.collection('game').doc(id).get().then(function (doc) {
                    var data = doc.data();
                    console.log(data);
                    var new_sup_money = data.sup_money + parseInt($('#new_sup_money').val());
                    console.log(new_sup_money);
                    db.collection('game').doc(id).update({
                        sup_money: new_sup_money,
                    });
                });





            })

            db.collection('game').doc(id).collection('support').doc(sup_id).update({
               
                //sup_user를 배열로 만들고 localStorage에 있는 user의 displayName을 push
                sup_user: firebase.firestore.FieldValue.arrayUnion(JSON.parse(뺀거).displayName)

            }).then(function () {
                alert('프로젝트가 수정되었습니다.');
                location.href = 'project_detail.html?id=' + id;
            }).catch(function (error) {
                alert('프로젝트 수정에 실패했습니다.');
            });
        });


        






    </script>

</body>

</html>